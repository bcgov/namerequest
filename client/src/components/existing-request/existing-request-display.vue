<template>
  <MainContainer id="analyze-pending-container">
    <template v-slot:container-header>
      <v-col cols="auto">
        <b>Your search returned the following Name Request:</b>
      </v-col>
    </template>
    <template v-slot:content>
      <v-row align="start" v-if="nr.nrNum">
        <v-col cols="auto" class="fs-24">
          <span class="h3 mr-2">{{ nr.nrNum }}</span>
        </v-col>
        <v-col class="bold-copy">
          <div style="display: inline-block" class="">
            <div v-for="name of names" :key="name.choice">{{ `${name.choice}) ${name.name}` }}</div>
          </div>
        </v-col>
        <v-col cols="12">
          <v-row class="pt-3">
            <v-col cols="9">
              <v-row dense class="mt-n5">
                <v-col cols="12">
                  <span class="bold-text">Last Update: </span> {{ lastUpdate }}
                </v-col>
                <v-col cols="12">
                  <span class="bold-text">Status: </span> {{ nr.state }}
                </v-col>
                <v-col cols="12">
                  <span class="bold-text">Priority Request: </span> {{ priorityReq ? 'Yes' : 'No' }}
                </v-col>
                <v-col cols="12">
                  <span class="bold-text">Expiry Date: </span> {{ expiryDate }}
                </v-col>
                <v-col cols="12">
                  <span class="bold-text">Submit Count: </span>{{ nr.submitCount }}
                </v-col>
                <v-col cols="12" v-if="nr.conditions">
                  <span class="bold-text">Condition/Consent: </span>
                </v-col>
                <v-col cols="12">
                  <span class="bold-text">Submitting Party: </span> {{ nr.applicants.lastName }},
                  {{ nr.applicants.firstName }}
                </v-col>
                <v-col cols="12">
                  <span class="bold-text">Address: </span> {{ address }}
                </v-col>
              </v-row>
            </v-col>
            <v-col cols="3" v-if="nr.state !== 'CANCELLED'">
              <v-row dense>
                <v-col cols="12"><v-btn block @click="edit">EDIT</v-btn></v-col>
                <v-col cols="12"><v-btn block>CANCEL</v-btn></v-col>
                <v-col cols="12" v-if="showReapply"><v-btn block>RE-APPLY</v-btn></v-col>
                <v-col cols="12" v-if="showReceipt"><v-btn block>RECEIPT</v-btn></v-col>
                <v-col cols="12" v-if="showIncorporate"><v-btn block>INCORPORATE</v-btn></v-col>
              </v-row>
            </v-col>
          </v-row>
        </v-col>
      </v-row>
    </template>
  </MainContainer>
</template>

<script lang="ts">
import newReqModule from '@/store/new-request-module'
import { Component, Vue } from 'vue-property-decorator'
import { NameRequestI } from '@/models'
import MainContainer from '@/components/new-request/main-container.vue'
import Moment from 'moment'

@Component({
  components: { MainContainer }
})
export default class ExistingRequestDisplay extends Vue {
  daysBeforeExpiry: number = 5

  get address () {
    let fields = ['addrLine2', 'city', 'stateProvinceCd', 'countryCd', 'postalCd']
    let output: string = this.nr.applicants.addrLine1
    for (let field of fields) {
      if (this.nr.applicants[field]) {
        output += ', ' + this.nr.applicants[field]
      }
    }
    return output
  }
  get addressLines () {
    let output = [ this.nr.applicants.addrLine1 ]
    if (this.nr.applicants.addrLine2) {
      output.push(this.nr.applicants.addrLine2)
    }
    return output
  }
  get cityProvPostal () {
    let { applicants } = this.nr
    return applicants.city + ', ' + applicants.stateProvinceCd + ', ' + applicants.postalCd
  }
  get expiryDate () {
    if (this.nr.expirationDate) {
      return Moment(this.nr.expirationDate).format('MMM Do[,] YYYY')
    }
    return ''
  }
  get lastUpdate () {
    if (this.nr.lastUpdate) {
      return Moment(this.nr.lastUpdate).format('MMM Do[,] YYYY')
    }
    return ''
  }
  get name () {
    let nameObj = this.nr.names.find(name => name.choice === 1)
    return nameObj.name
  }
  get names () {
    return this.nr.names.sort((a, b) => {
      if (a.choice > b.choice) {
        return 1
      }
      if (a.choice < b.choice) {
        return -1
      }
      return 0
    })
  }
  get nr () {
    return newReqModule.nr
  }
  get priorityReq () {
    return (this.nr.priorityCd && this.nr.priorityCd === 'Y')
  }
  get showIncorporate () {
    return false
  }
  get showReapply () {
    let firstDay = Moment(this.nr.expirationDate).subtract(this.daysBeforeExpiry, 'days')
    return Moment().isSameOrAfter(firstDay, 'day')
  }
  get showReceipt () {
    return (this.nr.state === 'APPROVED' || this.nr.state === 'CONDITION')
  }

  edit () {
    newReqModule.editExistingRequest()
  }
}

</script>

<style lang="sass" scoped>
.whitesmoke-bg
  background-color: whitesmoke

.max-height
  max-height: 60px

.no-style-button
  background-color: unset !important
  border: 0 !important
  border-radius: 0 !important
  box-shadow: unset !important

.forgot-nr-link
  text-decoration: underline
  cursor: pointer !important

</style>
